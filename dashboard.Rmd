---
title: "Poroteo Aborto 2020"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    css: style.css
---
<head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-N1GX94R8R8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-N1GX94R8R8');
</script>
</head> 

```{r setup, include=FALSE}
library(flexdashboard) # R Markdown Format for Flexible Dashboards, CRAN v0.5.2
library(gsheet) # Download Google Sheets Using Just the URL, CRAN v0.4.5
library(tidyverse) # Easily Install and Load the 'Tidyverse', CRAN v1.3.0
library(ggthemes) # Extra Themes, Scales and Geoms for 'ggplot2', CRAN v4.2.0
library(DT) # A Wrapper of the JavaScript Library 'DataTables', CRAN v0.15
library(plotly) # Create Interactive Web Graphics via 'plotly.js', CRAN v4.9.2.1
library(janitor) # Simple Tools for Examining and Cleaning Dirty Data, CRAN v2.0.1
library(polAr) # Argentina Political Analysis, CRAN v0.2.0
library(geofacet) # 'ggplot2' Faceting Utilities for Geographical Data, CRAN v0.2.0 
library(knitr)
library(kableExtra)
library(scales)
library(glue)
```

```{r,include=FALSE}
url <- "https://docs.google.com/spreadsheets/d/1TUTag7Majqhn5noRLLMUJ6SFJ0Phwlo-Oc1T59uSZCE/edit#gid=0"

a <- gsheet2text(url, format='csv')

df <- read_csv(a,skip = 1)

df <- df %>% 
  filter(!is.na(Cargo)) %>% 
  mutate(AbortoLegal = str_to_title(AbortoLegal))

df_tabla <- df

df <- df %>% 
  mutate(AbortoLegal = case_when(AbortoLegal == "Despenalizar" ~ "A Favor",
                                 AbortoLegal == "Se Abstiene"  ~ "Se Abstiene / Caso Especial",
                                 AbortoLegal == "Indefinido" |  
                                   AbortoLegal == "Sin Datos"  ~ "Sin Datos / Indefinido",
                                 TRUE ~ AbortoLegal))

conteo_diputados <- df %>% 
  filter(str_detect(Cargo, 'Diputados')) %>% 
  tabyl(AbortoLegal) %>% 
  adorn_pct_formatting() %>% 
  adorn_totals("row")
 
conteo_senadores <- df %>% 
  filter(str_detect(Cargo, 'Senadores')) %>% 
  tabyl(AbortoLegal) %>% 
  adorn_pct_formatting() %>% 
  adorn_totals("row")
```



```{r colores, include=FALSE}
colores <- c('A Favor'='#056e0c', 'En Contra'="#941017","Se Abstiene / Caso Especial"="#626c9e", "Sin Datos / Indefinido"='#b0b0b0')
```


# Inicio

Row {data-height=650}
-------------------------------------

### C치mara de Diputades

```{r}
# highchart parliament de Dai
```

Row {data-height=350}
-------------------------------------
   
### A favor / Despenalizar

```{r}
dip_si <- conteo_diputados %>% 
  filter(AbortoLegal == 'A Favor')

valueBox(paste0(dip_si$n,' (',dip_si$percent,')'), color = "#00A759")
```   
    
###


```{r}
conteo_diputados %>% 
  filter(!AbortoLegal %in% c('A Favor', 'En Contra')) %>% 
  kable('html', col.names = NULL) %>%
  kable_styling(font_size = 18)
```

### En contra

```{r}
dip_no <- conteo_diputados %>% 
  filter(AbortoLegal == 'En Contra')

valueBox(paste0(dip_no$n,' (',dip_no$percent,')'), color = "#a70600")
```


Row {data-height=650}
-------------------------------------

### C치mara de Senadores

```{r}
# highchart parliament de Dai
```

Row {data-height=350}
-------------------------------------
   
### A favor / Despenalizar

```{r}
sen_si <- conteo_senadores %>% 
  filter(AbortoLegal == 'A Favor')

valueBox(paste0(sen_si$n,' (',sen_si$percent,')'), color = "#00A759")
```


### 

```{r}
conteo_senadores %>% 
  filter(!AbortoLegal %in% c('A Favor', 'En Contra')) %>% 
  kable('html', col.names = NULL) %>%
  kable_styling(font_size = 18)
```


### En contra

```{r}
sen_no <- conteo_senadores %>% 
  filter(AbortoLegal == 'En Contra')

valueBox(paste0(sen_no$n,' (',sen_no$percent,')'), color = "#a70600")
```


# Gr치ficos

## Gr치ficos{.tabset}

```{r wragnle_df, echo=FALSE}

# AGREGO codprov COMO VARIABLE PARA JOIN NECESARIO CON GEOFACET
df <- df %>% 
  mutate(Distrito = str_to_upper(Distrito), 
         codprov = case_when(
           str_detect(Distrito, "JUJ")  ~ "10",
           str_detect(Distrito, "FORM")  ~ "09",
           str_detect(Distrito, "MISI")  ~ "14",
           str_detect(Distrito, "SALT")  ~ "17",
           str_detect(Distrito, "TUCU")  ~ "23",
           str_detect(Distrito, "CATAM")  ~ "03",
           str_detect(Distrito, "CHAC")  ~ "06",
           str_detect(Distrito, "CORR")  ~ "05",
           str_detect(Distrito, "ESTER")  ~ "22",
           str_detect(Distrito, "RDOBA")  ~ "04",
           str_detect(Distrito, "ENTRE")  ~ "08",
           str_detect(Distrito, "OJA")  ~ "12",
           str_detect(Distrito, "FE")  ~ "21",
           str_detect(Distrito, "NOMA")  ~ "01",
           str_detect(Distrito, "JUAN")  ~ "18",
           str_detect(Distrito, "LUIS")  ~ "19",
           str_detect(Distrito, "PAMP")  ~ "11",
           str_detect(Distrito, "MEN")  ~ "13",
           str_detect(Distrito, "NEU")  ~ "15",
           str_detect(Distrito, "NEGR")  ~ "16",
           str_detect(Distrito, "CHUB")  ~ "07",
           str_detect(Distrito, "CRUZ")  ~ "20",
           str_detect(Distrito, "FUEG")  ~ "24", 
           TRUE ~ "02" # pba
         ))

# AGREGO CONTEO DE n() DIPUTADOS PARA LABELS

 dipu_label <- df %>%  # FILTRO DIPUTADOS
  filter(str_detect(Cargo, "Dip")) %>%  # CONTEO DE DIPUTADES x PROVINCIA PARA LABELS
  group_by(codprov) %>% 
  count()
 
arg <- get_grid("ARGENTINA") %>% 
  left_join(dipu_label, by = c("code" = "codprov")) %>% 
  mutate(name = str_replace_all(name, 
                                pattern = " ", 
                                replacement = "\n"), 
         name_dip = paste0(name , "\n(", n , ")"))  # DESCARGO GRILLA DE ARGENTINA PARA GEOFACET
  
 
 

```



### Diputados por provincia


```{r geofacet_DIP, fig.height= 14, fig.width=7}

arg2 <- arg %>% 
  transmute(row, col, code, name = name_dip)

DIP <-   df %>%  # FILTRO DIPUTADOS
  clean_names() %>% 
  filter(str_detect(cargo, "Dip")) 

dip_pct <- DIP %>%  # DATA PARA PLOT 
  group_by(codprov, aborto_legal) %>% 
  summarise(n = n()) %>% 
  mutate(pct = round(n/sum(n)*100,1)) 

### GEOFACET - DIPUTADOS 

ggplot(dip_pct) +
  geom_col(aes(pct, '',  fill = aborto_legal), width = 1, alpha = .7)  +
  scale_fill_manual(values = colores) + 
  facet_geo(facets = ~ codprov , grid = arg2, label = "name") +
  scale_x_continuous(breaks = c(0,50,100),
                     labels = c("0%","50%","100%"),
                     expand = c(0, 0)) + 
  coord_flip() +
  geom_vline(xintercept = 50, color = "black", linetype = "dashed") +
  labs(title = "",
       subtitle = "", 
       x="",
       y="", 
       fill = "", 
       caption = "") +
  theme(legend.position = 'top',
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank()
        # ,plot.margin = unit(c(0,-2 ,-6,-6), "mm")
        )  

```


### Senadores por provincia

```{r geofacet_SEN, fig.asp= 2}
arg <- arg %>% 
  transmute(row, col, code, name)

SEN <- df %>%  # FILTRO SENADORES
  clean_names() %>% 
  filter(str_detect(cargo, "Sen")) 

sen_pct <- SEN %>% # DATA PARA PLOT
  group_by(distrito, codprov, aborto_legal) %>% 
  summarise(n = n()) %>% 
  mutate(pct = round(n/sum(n)*100,1)) 

# GEOFACET SENADORES 

ggplot(sen_pct) +
  geom_col(aes(pct, '',  fill = aborto_legal), width = 1, alpha = .7)  +
  scale_fill_manual(values = colores) +
  facet_geo(facets = ~ codprov , grid = arg, label = "name") +
  scale_x_continuous(breaks = c(0,50,100),
                      labels = c("0%","50%","100%"),
                      expand = c(0, 0)) + 
  coord_flip() +
  labs(title = "",
       subtitle = "", 
       x="",
       y="", 
       fill = "", 
       caption = "") +
  theme(legend.position = 'top',
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank()) 




```



```{r}
bloques_df <- df %>% 
  mutate(Bloque = str_to_title(Bloque),
         Bloque = str_replace(Bloque,'Pro\\b' , 'PRO'),
         Bloque = str_replace(Bloque,'Ucr\\b' , 'UCR'),
         Bloque = case_when(Bloque == "Frente De Izquierda Y De Los Trabajadores" ~ "FIT",
                            Bloque == "Pts - Frente De Izquierda" ~ "PTS - FIT",
                            TRUE ~ Bloque ),
         # Bloque = str_replace_all(Bloque, 
         #                        pattern = " ", 
         #                        replacement = "\n"),
         Bloque = if_else(nchar(Bloque)>15,glue("{substr(Bloque,1,15)}..."),Bloque),
         Bloque = fct_infreq(Bloque)) %>%
  group_by(Cargo, Bloque,AbortoLegal) %>% 
  count()
```


### Diputados por bloque

```{r fig.height= 5, fig.width=10}
bloques_df %>% 
  filter(str_detect(Cargo, 'Diputados'), !str_detect(AbortoLegal, 'Caso')) %>% #saco a Massa del grafico
  ggplot(aes(AbortoLegal, n, fill = AbortoLegal))+
  geom_col()+
  scale_fill_manual(values = colores)+
  scale_y_continuous(breaks= function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1)))))+
  labs(x='',y='') +
  theme_minimal() +
  theme(legend.position = 'bottom',
        # text = element_text(size=7),
        axis.text.x = element_blank())+
  facet_wrap(.~Bloque, scales = 'free')
```


### Senadores por bloque

```{r, fig.height= 5, fig.width=10}
bloques_df %>% 
  filter(str_detect(Cargo, 'Senadores')) %>% 
  ggplot(aes(AbortoLegal, n, fill = AbortoLegal))+
  geom_col()+
  scale_fill_manual(values = colores)+
  scale_y_continuous(breaks= function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1)))))+
  labs(x='',y='') +
  theme_minimal() +
  theme(legend.position = 'bottom',
        # text = element_text(size=7),
        axis.text.x = element_blank())+
  facet_wrap(.~Bloque, scales = 'free')
```

# Datos Diputados

```{r}
table_diputados <- df_tabla %>% 
  filter(Cargo == 'Diputados Nacionales') %>% 
  select(Nombre, Genero,Distrito,Bloque,AbortoLegal, FuenteAbortoLegal,twitter)

datatable(table_diputados ,
          extensions = 'Buttons',
          options = list(scrollY="200px", scrollX="300px",
                         dom = 'Bfrtip',
                         buttons =list('copy', 'print', list(extend = 'collection',
                                                             buttons = c('csv', 'excel'),
                                                             text = 'Descarga'))
                         ),  filter = 'top')

```

# Datos Senadores

```{r}
table_senadores <- df_tabla %>% 
  filter(Cargo == 'Senadores Nacionales') %>% 
  select(Nombre, Genero,Distrito,Bloque,AbortoLegal, FuenteAbortoLegal,twitter)

datatable(table_senadores ,
          extensions = 'Buttons',
          options = list(scrollY="200px", scrollX="300px",
                         dom = 'Bfrtip',
                         buttons =list('copy', 'print', list(extend = 'collection',
                                                             buttons = c('csv', 'excel'),
                                                             text = 'Descarga'))
                         ),  filter = 'top')

```

# Nosotres

(Link a la planilla abortera, nuestros contactos, etc.)

* TuQmano - [github.com/tuqmano](https://github.com/tuqmano)


